<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>明德微校园</title>
    <meta name="viewport"
          content="width=device-width, initial-scale=1.0, minimum-scale=0.5, maximum-scale=2.0, user-scalable=no"/>

    <link rel="stylesheet" href="http://g.alicdn.com/msui/sm/0.6.2/css/sm.min.css">
    <script type='text/javascript' src='http://g.alicdn.com/sj/lib/zepto/zepto.min.js' charset='utf-8'></script>
    <script type='text/javascript' src='http://g.alicdn.com/msui/sm/0.6.2/js/sm.min.js' charset='utf-8'></script>
    <link rel="stylesheet" href="http://g.alicdn.com/msui/sm/0.6.2/css/??sm.min.css,sm-extend.min.css">
    <script type='text/javascript' src='http://g.alicdn.com/msui/sm/0.6.2/js/??sm.min.js,sm-extend.min.js'
            charset='utf-8'></script>

    <script type="text/javascript" src="../js/jquery-2.1.4.js"></script>

    <!--jQuery-->
    <!-- head 中 -->
    <link rel="stylesheet" href="//cdn.bootcss.com/weui/1.1.1/style/weui.min.css">
    <link rel="stylesheet" href="//cdn.bootcss.com/jquery-weui/1.0.1/css/jquery-weui.min.css">

    <!-- body 最后 -->
    <script src="//cdn.bootcss.com/jquery-weui/1.0.1/js/jquery-weui.min.js"></script>

    <!-- 如果使用了某些拓展插件还需要额外的JS -->
    <script src="//cdn.bootcss.com/jquery-weui/1.0.1/js/swiper.min.js"></script>
    <script src="//cdn.bootcss.com/jquery-weui/1.0.1/js/city-picker.min.js"></script>
    <!--jQuery结束-->
    <script>
        function theme_dark() {
            var dateHour = new Date().getHours();
            if (dateHour > 20 || dateHour < 7) {
                $("body").addClass("theme-dark");
            } else {
                $("body").removeClass("theme-dark");
            }

        }
        function weixin() {
            var ua = window.navigator.userAgent.toLowerCase();
            if (ua.match(/MicroMessenger/i) == 'micromessenger') {
                theme_dark();
            } else {
//                location.href = "wrong.html";
            }
        }
    </script>

</head>
<body class="" onload="weixin();">

<header class="bar bar-nav">
    <h1 class='title'><img src="../img/loseOneTitle.png" width="20px" height="18px">&nbsp;信息发布</h1>
</header>
<div class="content" id="content-page">
    <form method="post" action="index/subs" enctype="multipart/form-data" id="loseform">
        <div class="list-block">
            <ul>
                <!-- Text inputs -->
                <li>
                    <div class="item-content">
                        <div class="item-media"><i class="icon icon-form-name"></i></div>
                        <div class="item-inner">
                            <!--<div class="item-title label">标题</div>-->
                            <img src="../img/form/title.png" style="width: 25px">
                            <div class="item-input">
                                <input type="text" placeholder="黑色钱包" maxlength="15" name="ltitle" id="ltitle">
                            </div>
                        </div>
                    </div>
                </li>
                <li>
                    <div class="item-content">
                        <div class="item-media"><i class="icon icon-form-gender"></i></div>
                        <div class="item-inner">
                            <!--<div class="item-title label">类型</div>-->
                            <img src="../img/form/type.png" style="width: 25px">
                            <input type="text" placeholder="请选择类型" id='ltype' maxlength="10" name="ltype"/>
                        </div>
                    </div>
                </li>

                <script>
                    $("#ltype").select({
                        title: "请选择类型",
                        items: ["失物上交", "失物申报"]
                    });
                </script>
                <li>
                    <div class="item-content">
                        <div class="item-media"><i class="icon icon-form-name"></i></div>
                        <div class="item-inner">
                            <!--<div class="item-title label">地点</div>-->
                            <img src="../img/form/location.png" style="width: 25px">
                            <div class="item-input">
                                <input type="text" placeholder="1号楼312" maxlength="15" name="location" id="location">
                            </div>
                        </div>
                    </div>
                </li>
                <li>
                    <div class="item-content">
                        <div class="item-media"><i class="icon icon-form-name"></i></div>
                        <div class="item-inner">
                            <!--<div class="item-title label">地点</div>-->
                            <img src="../img/form/phone.png" style="width: 25px">
                            <div class="item-input">
                                <input type="text" placeholder="155*****96" maxlength="11" name="lphone" id="lphone">
                            </div>
                        </div>
                    </div>
                </li>
                <li class="align-top">
                    <div class="item-content">
                        <div class="item-media"><i class="icon icon-form-comment"></i></div>
                        <div class="item-inner">
                            <!--<div class="item-title label"></div>-->
                            <img src="../img/form/info.png" style="width: 25px">
                            <div class="item-input">
                                <textarea class="weui-textarea" placeholder="请描述物品信息" rows="3" id="linfo"
                                          name="linfo"></textarea>
                                <div class="weui-textarea-counter"><span>0</span>/300</div>
                            </div>
                        </div>
                    </div>
                </li>

            </ul>

            <script type="text/javascript">
                $(function () {
                    $("#linfo").keyup(function () {
                        var val = $(this).val();
                        var len = val.length;
                        if (len > 300) {
                            $(this).val(val.substring(0, 300));
                            $.toptip('警告:字数到达上限', 'warning');
                        }
                        if (len <= 300) {
                            $(".weui-textarea-counter > span").html(len);
                        }
                    });
                });

            </script>


            <div class="weui-cell">
                <div class="weui-cell__bd">
                    <div class="weui-uploader">
                        <div class="weui-uploader__hd">
                            <p class="weui-uploader__title">图片上传</p>
                        </div>
                        <div class="weui-uploader__bd">
                            <li class="weui-uploader__file"></li>
                            <div class="weui-uploader__input-box">
                                <input class="weui-uploader__input" id="file" type="file"
                                       accept="image/*"
                                       name="file" multiple="">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <script type="text/javascript">
            <!--图片预览-->
            $("#file").on('change', function () {

                    if (typeof (FileReader) != "undefined") {

                        var reader = new FileReader();
                        reader.readAsDataURL($(this)[0].files[0]);
                        reader.onload = function (e) {
//                            alert(e.target.result);
                            if (reader.size > (1024 * 1024 * 3)) {
                                $.toast("文件过大");
                            }
                            $(".weui-uploader__file").css("background-image", "url('" + e.target.result + "')");
                        }
                    }
                    else {
                        alert("你的浏览器不支持FileReader.");
                    }
                }
            );
        </script>

    </form>
    <script type="text/javascript">
        var t = 1;
        $(document).ready(function () {
            $("#lphone").focus(function () {
                $(this).val("");
                $(this).css("color", "");
            });

            $("#sub").bind('click', function () {

                var formdata = new FormData();
//                用于标记信息填写情况
                var flagCount = 0;
                $(":input").each(function (index) {
                    //                    loseInfoEntity[index] = $(this).val();
                    if (index != 5) {
                        var inputObj = $(this);
                        var valus = inputObj.val().replace(/(^s+)|(\s+$)/g, "");
                        if (valus == null || valus == "" || valus == undefined) {
                            flagCount++;
                        } else {
                            if (index == 3) {
                                if (!(/^1[34578]\d{9}$/.test(valus))) {
                                    inputObj.css("color", "red");
                                    flagCount -= 50;
                                }
                            }
                            formdata.append($(this).attr("name"), valus);
                        }
                    } else {
                        var file = $(this)[0].files[0];
                        if (file.size > (1024 * 1024 * 3)) {
                            $.toast("文件不能超过3M");
                            flagCount += 100;
                        }
                        formdata.append($(this).attr("name"), file);
                    }
                });
                if (flagCount == 0) {
                    $.showLoading("上传文件中");
                    commitSub(formdata);
                }
                if (flagCount > 0) {
                    $.toptip("请将信息填写完整", "error");
                }
                if (flagCount < 0) {
                    $.toptip("请重新填写红色字体处", "error");
                }
            });
        });


        //提交评论信息
        function commitSub(formdata) {
            $.ajax({
                url: 'index/subs',
                type: 'POST',
                dataType: 'json',
                data: formdata,
                cache: false,
                processData: false,
                contentType: false,
                success: function (data) {
                    if (data == "ok") {
                        $.toast("提交成功", 100);
                        setInterval("turnTo()", 500);
                    }
                }, error: function () {
                    $.toast("提交失败", "forbidden");
                }
            });
        }
        //跳转
        function turnTo() {
            $.showLoading("跳转中", 590);
            if (t == 0) {
                location.href = "index.html";
            }
            t--;
        }
    </script>
    <div id="progressbar1"></div>
    <div class="content-block">
        <div class="row">
            <div class="col-50"><a href="javascript:history.back(-1)"
                                   class="button button-big button-fill button-danger">返回</a></div>
            <div class="col-50"><a href="javascript:;" id='sub'
                                   class="button button-big button-fill button-success">提交</a></div>
        </div>
    </div>

    <div class="weui-footer">
        <p class="weui-footer__text">©明德微校园</p>
    </div>
</div>

</body>
</html>